<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Favicon -->
  <link rel="icon" href="/jekyll-theme-hackcss/favicon.png">

  <!-- Meta information -->
  <title>Mitigations</title>
  <meta name="description"
        content="">
  <link rel="canonical"
        href="http://localhost:4000/jekyll-theme-hackcss/mitigations" />

  <!-- hack.css -->
  <link rel="stylesheet" href="https://npmcdn.com/hack/dist/hack.css" />
  

  <!-- Prism.js -->
  <link rel="stylesheet" href="https://npmcdn.com/prismjs@1.5.1/themes/prism.css" />

  <!-- Custom style -->
  <link rel="stylesheet" href="/jekyll-theme-hackcss/css/main.css" />

  <!-- Feed -->
  <link rel="alternate" type="application/rss+xml" title="bomb.codes"
        href="/jekyll-theme-hackcss/feed.xml" />

  <!-- 'jekyll-seo' plugin -->
  <!-- Begin Jekyll SEO tag v2.1.0 -->
<title>Mitigations - bomb.codes</title>
<meta property="og:title" content="Mitigations" />
<meta name="description" content="" />
<meta property="og:description" content="" />
<link rel="canonical" href="http://localhost:4000/jekyll-theme-hackcss/mitigations" />
<meta property="og:url" content="http://localhost:4000/jekyll-theme-hackcss/mitigations" />
<meta property="og:site_name" content="bomb.codes" />
<script type="application/ld+json">
{"@context": "http://schema.org",
"@type": "WebPage",
"headline": "Mitigations",
"description": "",
"url": "http://localhost:4000/jekyll-theme-hackcss/mitigations"}</script>
<!-- End Jekyll SEO tag -->

</head>



  
  <body class="hack">
  

    <a href="https://github.com/bones-codes/bombs" class="github-corner">


  <svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg>


</a>

<style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>


    <div class="container">
      <div class="grid">
        <aside class="cell -2of12" role="navigation">
          <div class="t-hackcss-navigation">
  <h2 class="t-hackcss-navigation-heading">Menu</h2>

  <nav class="menu" role="menubar">
    
    
      <a class="menu-item "
        role="menuitem" href="/jekyll-theme-hackcss/" title="">
        Home <div class="pull-right">»</div>
      </a>
    
      <a class="menu-item "
        role="menuitem" href="/jekyll-theme-hackcss/bombs" title="">
        Bombs <div class="pull-right">»</div>
      </a>
    
      <a class="menu-item active"
        role="menuitem" href="/jekyll-theme-hackcss/mitigations" title="">
        Mitigations <div class="pull-right">»</div>
      </a>
    
  </nav>

</div>

        </aside>

        <main class="cell -9of12">
          <h1 id="mitigations">Mitigations</h1>

<p>To effectively mitigate decompression bomb attacks, a layered defense is the best approach. Implementing various checks and restrictions for application and processes will ensure that the attack is stopped before any lasting damage can occur.</p>

<hr />

<h2 id="defense-layer-1"><a name="layer1"></a>Defense Layer 1</h2>

<p>Client-side checks should never be relied upon for security. Server-side checks should be performed to validate:</p>
<ol>
  <li>File format is expected for context</li>
  <li>Upload file size does not exceed the maximum limit</li>
</ol>

<hr />

<h2 id="defense-layer-2"><a name="layer2"></a>Defense Layer 2</h2>

<p>Limit the amount of resources available to the process and its children. This should be done at both the OS and application level.</p>

<p>For Linux platforms, cgroups can and should be used to limit both CPU and memory usage.</p>

<p>In Python resource limits can be configured via the <code class="highlighter-rouge">resource</code> module’s <code class="highlighter-rouge">setrlimit</code> and <code class="highlighter-rouge">RLIMIT*</code> directives:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">resource</span>
<span class="n">rsrc</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_DATA</span>
<span class="n">resource</span><span class="o">.</span><span class="n">setrlimit</span><span class="p">(</span><span class="n">rsrc</span><span class="p">,</span> <span class="p">(</span><span class="mi">1024000</span><span class="p">,</span> <span class="n">hard</span><span class="p">))</span> <span class="c"># limit to 1MB</span></code></pre></figure>

<p>Ruby’s <code class="highlighter-rouge">Process</code> module has similar <code class="highlighter-rouge">RLIMIT</code> directives</p>

<hr />

<h2 id="defense-layer-3"><a name="layer3"></a>Defense Layer 3</h2>

<p>In addition, filetype-specific mitigations should also be implemented depending on the context of the compression in use.</p>

<div class="btn-group">
  <a class="btn btn-default btn-ghost" href="#archives">Archives</a>
  <a class="btn btn-default btn-ghost" href="#images">Images</a>
  <a class="btn btn-default btn-ghost" href="#http">HTTP</a>
</div>
<p> </p>

<h3 id="archives"><a name="archives"></a>Archives</h3>

<p>Restrict output file size and number of extracted files to ensure the total doesn’t exceed the maximum limit. An exception should be thrown if either of these limits are reached.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">zlib</span>
<span class="k">def</span> <span class="nf">decompress</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">maxsize</span><span class="o">=</span><span class="mi">1024000</span><span class="p">):</span>
    <span class="n">dec</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompressobj</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dec</span><span class="o">.</span><span class="n">unconsumed_tail</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">"Possible bomb"</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">dec</span>
    <span class="k">return</span> <span class="n">data</span></code></pre></figure>

<p>Some filetypes have headers that report the output file size (ZIP, Gzip, etc.). These headers should be checked, but never solely relied upon since it isn’t difficult to modify these values.</p>

<h3 id="images"><a name="images"></a>Images</h3>

<p>Workers should be employed for process intensive tasks, such as image modifications. This will ensure that the application isn’t knocked out due to a task such as a size increase.</p>

<p>In addition, default image library size limitations should be changed to reflect safe values that the process can handle in most circumstances. For example, libpng default size limitations are 1,000,000 by 1,000,000 pixels. Unless you’re NASA and have the power to host and process such massive images, you should probably change these values to something a bit more sane. The default libpng size limitations can be modified via the <code class="highlighter-rouge">png_set_user_limits</code> method.</p>

<p>Prior to processing an image, dimensions should be programmatically checked. This can be accomplished via filetype headers. Various languages have libraries/modules that implement this check. For example, in Python this can be done using PIL’s \texttt{Image} module:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">image_filename</span><span class="p">)</span>
<span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">size</span>
<span class="c"># Check image dimensions</span>
<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&lt;</span> <span class="n">MAX_IMAGE_WIDTH</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">height</span> <span class="o">&lt;</span> <span class="n">MAX_IMAGE_HEIGHT</span><span class="p">):</span> 
    <span class="c"># do stuff</span></code></pre></figure>

<p>These values are extremly easy to change, so never rely solely upon the reported dimensions. Be sure to have both <a href="#layer1">layer 1</a> and <a href="#layer2">layer 2</a> defenses implemented.</p>

<p>When implementing layer 2 defenses for a libpng application, limits can be placed on memory consumption and ancillary chunks via the <code class="highlighter-rouge">png_set_chunk_malloc_max</code> and <code class="highlighter-rouge">png_set_chunk_cache_max</code> methods.</p>

<h3 id="http"><a name="http"></a>HTTP</h3>

<p>Layer 2 defense implementation for Apache should make use of the various <code class="highlighter-rouge">RLimit*</code> directives (<code class="highlighter-rouge">RLimitCPU</code>, <code class="highlighter-rouge">RLimitMEM</code>, <code class="highlighter-rouge">RLimitNPROC</code>). For Nginx, the <code class="highlighter-rouge">worker_rlimit_core</code>, <code class="highlighter-rouge">worker_rlimit_nofile</code>, and <code class="highlighter-rouge">worker_processes</code> directives can be used.</p>

<p>Request sizes should be limited. Both Apache (<code class="highlighter-rouge">LimitRequestBody</code>) and Nginx (<code class="highlighter-rouge">client_max_body_size</code>) have directives to support this.</p>

<p>In addition, the accepted compression ratio should also be modified. If not, an attacker could simply edit the compression ratio to reduce the bomb to an accepted size. Apache supports this via <code class="highlighter-rouge">mod_deflate</code>’s <code class="highlighter-rouge">DeflateInflateRatioLimit</code>, <code class="highlighter-rouge">DeflateInflateRatioBurst</code>, and <code class="highlighter-rouge">DeflateWindowSize</code> directives.</p>


        </main>
      </div>

    <footer class="t-hackcss-footer">
  <hr />

  <h3 class="footer-heading">bomb.codes</h3>

  <div class="grid t-hackcss-sm-reversed-grid">

    <div class="cell -5of12">
      <div class="contact-list">
        <p>
        <!--  ,
          <a href="mailto:"></a>-->
	Maintained by 
        
          
          <span class="t-hackcss-social">
            <i class="t-hackcss-icon"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"></path></svg>
</i>
            <a href="https://github.com/bones-codes">bones-codes</a>
          </span>
        
          
          <span class="t-hackcss-social">
            <i class="t-hackcss-icon"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</i>
            <a href="https://twitter.com/bones_codes">bones_codes</a>
          </span>
        
	<br>Support provided by <a href="https://nccgroup.trust">NCC Group</a>
        </p>

      </div>
    </div>

    <div id="footer-spacer" class="cell -1of12"></div>

    <div class="cell -6of12">
      <p></p>
    </div>
  </div>

</footer>


    </div>

    <!-- Prism.js -->
    <script src="https://npmcdn.com/prismjs@1.5.1/prism.js"></script>
  </body>

</html>
